/*! PDX Roasters - v0.1.0 - 2013-02-08
* http://PROJECT_WEBSITE/
* Copyright (c) 2013 PDX Roasters; Licensed MIT */
(function(e){"use strict";e.console=e.console||function(){},e.pdx={},e.pdx.app={}})(window),function(e,t,n){"use strict";var r=e(document),i=e("#header");e(".scroll-to").on("click",function(t){t.preventDefault();var n=e(this.hash);e.scrollTo(n.offset().top-i.height())}),e(".ajax-form").on("submit",function(t){t.preventDefault(),e.ajax({url:this.action,type:"json",data:e(this).serialize(),error:function(){console.log("Ajax form error")},success:function(){console.log("Ajax form success")}})})}(ender,window),function(e,t){e.pdx.maps={lib:"http://maps.google.com/maps/api/js",query:{sensor:!1,callback:"pdx.maps.init"},callbacks:[],mapsloaded:!1,lazyload:function(){var e=document.createElement("script"),t=document.getElementsByTagName("script")[0];e.src=this.lib+"?"+this.parseQuery(),e.type="text/javascript",e.async=!0,t.parentNode.insertBefore(e,t)},onmapsready:function(e){if(this.mapsloaded)return console.log("[window.pdx.maps]: mapsloaded, can't push callbacks"),!1;this.callbacks.push(e)},firemapsready:function(){if(this.mapsloaded)return console.log("[window.pdx.maps]: mapsloaded, can't fire callbacks"),!1;for(var e=0,t=this.callbacks.length;e<t;e++)typeof this.callbacks[e]=="function"&&this.callbacks[e]()},parseQuery:function(e){var t=e||this.query,n=[];for(var r in t)n.push(r+"="+t[r]);return n.join("&")}},e.pdx.maps.lazyload(),e.pdx.maps.init=function(){if(e.pdx.maps.mapsloaded)return console.log("[window.pdx.maps]: init method already fired"),!1;var t=new google.maps.Geocoder;(function(){var t=function(){};t.prototype=new google.maps.OverlayView,t.extend=function(e){function r(){this.init&&this.init.apply(this,arguments)}var t=new this;for(var n in e)t[n]||(t[n]=e[n]);return r.prototype=t,r.prototype.constructor=r,r.extend=arguments.callee,r},e.pdx.maps.Overlay=t})(),"use strict",e.pdx.maps.Marker=e.pdx.maps.Overlay.extend({init:function(e){if(!e||!e.latLng||!e.map)return console.log("[Marker requires latLng and map]"),!1;var t=this;this.element=document.createElement("div"),this.loaded=!1;for(var n in e)this[n]=e[n];this.setMap(this.map),this.beChange=google.maps.event.addListener(this.map,"bounds_changed",function(){return t.panMap.apply(t)})},onAdd:function(){var e=this;this.element.style.position="absolute",this.element.className="marker-custom",this.element.innerHTML="<div><div></div></div>",this.tooltip=document.createElement("span"),this.tooltip.className="tooltip",this.tooltip.innerHTML="<div>"+this.name+"</div>",this.loader=document.createElement("span"),this.loader.className="plus-spinner",this.loader.innerHTML="<div></div>",this.element.appendChild(this.tooltip),this.element.appendChild(this.loader),this.getPanes().floatPane.appendChild(this.element),this.onAddCallback&&typeof this.onAddCallback=="function"&&this.onAddCallback(this)},draw:function(){var e=this.getProjection().fromLatLngToDivPixel(this.latLng);if(!e)return console.log("[Marker failed]"),!1;this.tooltip.style.left=-(this.tooltip.clientWidth/2-this.element.clientWidth/2)+"px",this.loader.style.left=-(this.loader.clientWidth/2-this.element.clientWidth/2)+"px",this.loader.style.top=-(this.loader.clientHeight+3)+"px",this.element.style.left=e.x-this.element.clientWidth/2+"px",this.element.style.top=e.y-this.element.clientHeight+"px"},setPosition:function(e){return this.element?(this.latLng=e,this.draw(),!0):!1},getPosition:function(){return this.element?this.latLng:null},onRemove:function(){return this.element?(this.element.parentNode.removeChild(this.element),!0):!1},remove:function(){if(!this.element)return;this.element.parentNode.removeChild(this.element),this.element=null},panMap:function(){if(!this.map||!this.infowindow)return;var e=this.map.getBounds(),t=this.getProjection().fromLatLngToDivPixel(this.latLng),n=this.infowindow.clientHeight,r=this.infowindow.clientWidth,i={top:this.element.offsetTop,left:this.element.offsetLeft,width:this.element.clientWidth,height:this.element.clientHeight},s={iwTopLeft:new google.maps.Point(t.x-r/2,t.y-n),iwTopRight:new google.maps.Point(t.x+r/2,t.y-n),iwBottomLeft:new google.maps.Point(t.x-r/2,t.y),iwBottomRight:new google.maps.Point(t.x+r/2,t.y)},o,u,a,f,l,c,h,p;if(!e)return;a=this.getProjection().fromDivPixelToLatLng(s.iwTopRight),f=this.getProjection().fromDivPixelToLatLng(s.iwBottomLeft),o=e.contains(a),u=e.contains(f);if(!o||!u)h=t.x,p=t.y,c=new google.maps.Point(h,p),l=this.getProjection().fromDivPixelToLatLng(c),this.map.panTo(l);google.maps.event.removeListener(this.beChange)}}),e.pdx.maps.geocode=function(e,n){t.geocode(e,function(e,t){if(t!==google.maps.GeocoderStatus.OK)return;typeof n=="function"&&n(e[0].geometry.location,e[0])})},e.pdx.maps.firemapsready(),e.pdx.maps.mapsloaded=!0}}(window),function(e,t,n){"use strict";var r=require("Class");t.pdx.PushState=r.extend({init:function(){this.state,this.from,this.on,this.cache={},this.poppable=!1,this.pushable="history"in t&&"pushState"in t.history,this._popEnable()},push:function(e,n){var r=this;this.from=t.location.href,this.on=e,typeof this.before=="function"&&this.before(),this._get(e,function(i){typeof n=="function"&&n(i),r.pushable&&t.history.pushState({},"",e),typeof r.after=="function"&&r.after(i),r.cache[e]=i})},_get:function(t,n){if(this.cache[t])return typeof n=="function"&&n(this.cache[t]),!1;e.ajax({url:t,type:"json",error:function(e){var t={text:e.statusText,code:e.status,error:!0};typeof n=="function"&&n(t)},success:function(e){typeof n=="function"&&n(e)}})},_popEnable:function(){if(!this.pushable||this.poppable)return!1;var e=this;this.poppable=!0,t.onpopstate=function(t){e.state=t.state}}})}(ender,window),function(e,t,n){"use strict";var r=require("mustache");t.pdx.templates={infowindow:function(e){var t="";return t="<h3>{{ name }}</h3>",t+='<div class="group">',t+='<div class="col col1of2">',t+='<div class="ci">{{ address }}</div>',t+="</div>",t+='<div class="col col1of2">',t+='<p class="hours ci">',t+="Mon. - Fri. <span>8 - 12</span><br />",t+="Sat. <span>8 - 12</span><br />",t+="Sun. <span>8 - 12</span>",t+="</p>",t+="</div>",t+="</div>",t+='<div class="btns group">',t+='<div class="col col1of2">',t+='<div class="ci"><a href="#{{ id }}" class="btn find">Find this Roast</a></div>',t+="</div>",t+='<div class="col col1of2">',t+='<div class="ci"><a href="/roaster/{{ slug }}/" class="btn more">Learn More</a></div>',t+="</div>",t+="</div>",t+='<a href="#close" class="plus-close">Close</div>',r.render(t,e)}}}(ender,window),function(e,t,n){"use strict";var r=e(document),i=e("#header");t.pdx.app.home={init:function(){var e=this;this._nav(),this._premaps(),this._roasters(),this._info(),this._resize(),this._pushes()},_nav:function(){var n=this;this.$nav=e("#nav"),this.$navTog=this.$nav.find(".plus"),this.$navLinks=this.$nav.find("a:not(.plus)"),this.$navTog.on("click",function(t){t.preventDefault(),n.$navTog.toggleClass("active"),n.$nav.toggleClass("active"),n.$navTog.is(".active")?e("[href='"+n.activeHash+"']").click():n.$info.removeClass("active")}),this.$navLinks.on("click",function(i){i.preventDefault(),n.$info.is(".active")||n.$info.addClass("active"),n.$info.css("top",e(t).scrollTop()),n.$navLinks.removeClass("on"),e(this).addClass("on"),n.$activePanel=e(this.hash),n.activeHash=this.hash,n.$panelWrap.css("left",-(n.$activePanel.index()*r.width()))})},_premaps:function(){var n=this;this.$mapWrap=e("#map-wrap"),this.$map=e("#map"),this.$mapPage=e("#map-page"),this.$closeMapPage=this.$mapPage.find(".plus-close"),this.mapElem=this.$map.get(0),this.mapMarkers=[],this.$mapWrap.add(this.$mapPage).height(t.innerHeight),this.$closeMapPage.on("click",function(e){e.preventDefault(),n.$mapPage.removeClass("active")}),t.pdx.maps.onmapsready(function(){n._map()})},_map:function(){var n=this;this.portland={lat:45.5239,lng:-122.67,latLng:new google.maps.LatLng(45.5239,-122.67)},this.mapSettings={center:this.portland.latLng,disableDoubleClickZoom:!1,draggingCursor:"move",draggableCursor:"default",mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,panControl:!1,panControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER},scrollwheel:!1,streetViewControl:!1,zoom:15,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER,style:google.maps.ZoomControlStyle.LARGE}},this.mapBounds=new google.maps.LatLngBounds,this.map=new google.maps.Map(this.mapElem,this.mapSettings);var r=[{featureType:"water",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#c4d3d8"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#ffffff"},{visibility:"on"}]},{featureType:"landscape.man_made",stylers:[{visibility:"on"},{color:"#e7e4d9"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{visibility:"on"},{color:"#c2dc96"}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#adafae"},{visibility:"on"}]},{featureType:"road.arterial",elementType:"labels.text.stroke",stylers:[{weight:1.6},{visibility:"on"},{color:"#f9f6ed"}]},{featureType:"road.arterial",elementType:"labels.text.fill",stylers:[{color:"#aeaead"}]},{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road.highway",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"road.arterial",elementType:"geometry.stroke",stylers:[{visibility:"on"},{color:"#c8c9c9"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{visibility:"on"},{color:"#c1c2c2"}]},{featureType:"road.local",elementType:"labels.text.fill"},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#bebab4"}]},{featureType:"road.highway",elementType:"labels.text.stroke",stylers:[{color:"#fffffe"}]},{featureType:"road.highway",elementType:"labels.text.fill",stylers:[{color:"#898c8c"}]},{featureType:"road.arterial",elementType:"labels.text.fill",stylers:[{color:"#969694"}]},{featureType:"transit.line",elementType:"geometry.fill",stylers:[{lightness:9},{visibility:"on"},{color:"#8f908d"}]},{featureType:"administrative.land_parcel",elementType:"geometry.stroke",stylers:[{color:"#d6d2cc"}]},{featureType:"poi.sports_complex",elementType:"geometry.fill",stylers:[{color:"#ccd89d"}]},{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#9e9a97"},{visibility:"off"}]},{featureType:"administrative",elementType:"labels.text.stroke",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"labels.text",stylers:[{color:"#6c9e85"},{visibility:"off"}]}];this.map.setOptions({styles:r});if(!this.$roasterItems.length)return!1;this.$roasterItems.each(function(r){var i=e(this),s=i.data(),o=s.latlng,u=s.name,a=s.api="/api/roaster/"+this.id+"/",f=s.address,l=this.id,c,h;if(!o)t.pdx.maps.geocode({address:f+" Portland, Oregon"},function(e){c=e,h=new t.pdx.maps.Marker({latLng:c,map:n.map,onAddCallback:function(e){n._onAddMarker(e,s)}}),n.mapMarkers.push(h),n.mapBounds.extend(c),n.mapMarkers.length===n.$roasterItems.length&&n.map.fitBounds(n.mapBounds)});else{try{o=JSON.parse(o)}catch(p){console.log("[window.pdx.home]: Did not parse lat/lng")}typeof o=="object"&&(c=new google.maps.LatLng(o[0],o[1]),h=new t.pdx.maps.Marker({latLng:c,map:n.map,onAddCallback:function(e){n._onAddMarker(e,s)}}),n.mapMarkers.push(h),n.mapBounds.extend(c))}}),this.mapMarkers.length===this.$roasterItems.length&&this.map.fitBounds(this.mapBounds)},_onAddMarker:function(n,r){var s=this,o=e(n.element),u=o.find(".tooltip"),a=o.find(".plus-spinner > div"),f,l;o.find(".tooltip").text(r.name),o.on("mouseenter","> div",function(){var t=e(this);if(f&&!f.is(".inactive"))return u.addClass("loading").css("top","50%"),!1;o.addClass("active"),u.removeClass("loading").css("top",-(u.height()-4))}).on("mouseleave","> div",function(t){var n=e(this);if(f&&!f.is(".inactive"))return u.addClass("loading").css("top","50%"),!1;o.removeClass("active"),u.removeClass("loading").css("top","50%")}),o.on("click","> div",function(c){function p(){l=setTimeout(function(){a.toggleClass("loading"),p()},300)}var h=e(this);e(".marker-custom").removeClass("active"),e(".infowindow").addClass("inactive");if(n.loaded)return o.addClass("active"),f.toggleClass("inactive"),u.addClass("loading").css("top","50%"),f.is(".inactive")?f.css("top","80%"):f.css("top",-(f.height()+3)),!1;u.addClass("loading"),a.parent().addClass("active"),a.addClass("loading"),p(),e.ajax({url:r.api,type:"json",data:{format:"json"},error:function(){clearTimeout(l),console.log("Infowindow load error")},success:function(r){var c=t.pdx.templates.infowindow(r);clearTimeout(l),n.loaded=!0,f=e("<span>").addClass("infowindow").hide(),n.infowindow=f[0],f.html(c).insertAfter(u).css("top",-(f.height()+20)).css("left",-(f.width()/2-h.width()/2)),f.find(".plus-close").on("click",function(e){e.preventDefault(),f.toggleClass("inactive"),f.is("inactive")?f.css("top","50%"):f.css("top",-(f.height()+3))}),f.find(".find").on("click",function(t){t.preventDefault();var n=e(this.hash),r=n.find(".toggle");if(n.is(".active"))return e.scrollTo(n.offset().top-i.height()),!1;s.$roasterTogs.removeClass("active"),r.addClass("active"),s.$roasterItems.removeClass("active"),n.addClass("active"),e.scrollTo(n.offset().top-i.height())}),f.find(".more").on("click",function(e){e.preventDefault(),s.pushState.push(this.href,function(e){e.error,s.$mapPage.addClass("active")})}),setTimeout(function(){f.show().removeClass("loading"),a.parent().removeClass("active"),a.removeClass("loading"),o.addClass("loaded").addClass("active"),n.panMap()},300)}})})},_info:function(){this.$info=e("#info-panel"),this.$panelWrap=this.$info.find(".panels"),this.$panels=this.$info.find(".panel"),this.$panels.width(r.width()),this.$panelWrap.width(r.width()*this.$panels.length),this.$info.add(this.$panels).height(t.innerHeight)},_roasters:function(){var t=this;this.$roasters=e("#roasters"),this.$roasterItems=this.$roasters.find(".roaster"),this.$roasterTogs=this.$roasters.find(".toggle"),this.$roasterHandles=this.$roasters.find(".handle");if(!this.$roasterItems.length)return this.$roasters.find(".suggest").on("click",function(t){t.preventDefault(),e("[href='"+this.hash+"']").click()}),!1;this.$roasterHandles.on("click",function(n){n.preventDefault();var r=e(this),s=r.find(".toggle"),o=r.closest(".roaster");if(o.is(".active"))return s.removeClass("active"),t.$roasterItems.removeClass("active"),!1;t.$roasterTogs.removeClass("active"),s.addClass("active"),t.$roasterItems.removeClass("active"),o.addClass("active"),e.scrollTo(o.offset().top-i.height())})},_resize:function(){var e=this;t.onresize=function(){e.$mapWrap.add(e.$mapPage).add(e.$info).add(e.$panels).height(t.innerHeight),e.$panels.width(r.width()),e.$panelWrap.width(r.width()*e.$panels.length)}},_pushes:function(){var e=this;this.pushState=new t.pdx.PushState,this.pushState.before=function(){console.log("before",arguments)},this.pushState.after=function(){console.log("after",arguments)}}}}(ender,window),function(e,t){"use strict";var n=e(document.body).data("controller");t.pdx.app[n]&&t.pdx.app[n].init&&t.pdx.app[n].init()}(ender,window);